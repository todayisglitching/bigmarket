{% extends "marketplace/base.html" %}

{% block title %}Корзина | BigMarket{% endblock %}

{% block content %}
<div class="mb-6">
  <h1 class="text-3xl font-semibold tracking-tight text-white">Корзина</h1>
  <p class="text-sm text-white/60">Ваши выбранные товары</p>
</div>

{% if cart_items %}
<section class="grid gap-6 lg:grid-cols-[2fr,1fr]">
  <div class="space-y-4">
    {% for item in cart_items %}
      <article class="flex flex-col gap-3 rounded-lg border border-white/10 bg-neutral-900 p-4 shadow-sm sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-center gap-4">
          <div class="h-20 w-20 flex-shrink-0 overflow-hidden rounded-lg bg-neutral-800">
            {% if item.product.product_photos.all %}
              <img src="{{ item.product.product_photos.all.0.photo.url }}" alt="{{ item.product.title }}" class="h-full w-full object-cover"/>
            {% elif item.product.thumbnail %}
              <img src="{{ item.product.thumbnail.url }}" alt="{{ item.product.title }}" class="h-full w-full object-cover"/>
            {% else %}
              <div class="flex h-full w-full items-center justify-center text-xs text-white/50">Нет фото</div>
            {% endif %}
          </div>
          <div class="space-y-1">
            <h3 class="text-base font-semibold leading-snug text-white">
              <a href="{% url 'product_detail' item.product.id %}" class="hover:text-blue-400">{{ item.product.title }}</a>
            </h3>
            <p class="text-sm text-white/60">{{ item.product.seller.company_name }}</p>
            <p class="text-xs text-white/50">Цена: {{ item.product.price }} ₽ за шт.</p>
            {% if item.product.stock < item.quantity %}
              <p class="text-xs text-red-400">Внимание! Доступно только {{ item.product.stock }} шт.</p>
            {% endif %}
          </div>
        </div>
        <div class="flex items-center gap-4 sm:w-64 sm:justify-end">
          <form method="post" action="{% url 'update_cart_item' item.id %}" class="flex items-center gap-2">
            {% csrf_token %}
            <label class="text-sm text-white/60">Кол-во:</label>
            <input 
              type="number" 
              name="quantity" 
              value="{{ item.quantity }}" 
              min="1" 
              max="{{ item.product.stock }}"
              class="w-16 rounded-lg border border-white/10 bg-neutral-950 px-2 py-1 text-center text-white focus:border-blue-400 focus:outline-none"
            />
            <button type="submit" class="rounded-lg bg-blue-700 px-3 py-1 text-sm font-semibold text-white hover:bg-blue-800">Обновить</button>
          </form>
          <div class="text-right">
            <p class="text-lg font-semibold text-white">{{ item.get_total_price }} ₽</p>
          </div>
          <form method="post" action="{% url 'remove_from_cart' item.id %}">
            {% csrf_token %}
            <button type="submit" class="rounded-lg bg-red-700 px-3 py-1 text-sm font-semibold text-white hover:bg-red-800">Удалить</button>
          </form>
        </div>
      </article>
    {% endfor %}
  </div>

  <div class="space-y-4">
    <div class="rounded-lg border border-white/10 bg-neutral-900 p-5 shadow-sm">
      <h2 class="text-lg font-semibold text-white">Итог</h2>
      <dl class="mt-4 space-y-2 text-sm">
        <div class="flex items-center justify-between">
          <dt class="text-white/60">Товары ({{ cart_items|length }})</dt>
          <dd class="font-medium text-white">{{ total }} ₽</dd>
        </div>
        <div class="flex items-center justify-between border-t border-dashed border-white/10 pt-2 text-base">
          <dt class="font-semibold text-white">Итого</dt>
          <dd class="font-semibold text-white">{{ total }} ₽</dd>
        </div>
      </dl>
      <button class="mt-4 w-full rounded-lg bg-blue-700 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-blue-800 transition">
        Оформить заказ
      </button>
      <a href="{% url 'index' %}" class="mt-2 block w-full text-center rounded-lg border border-white/10 px-4 py-2 text-sm font-semibold text-white transition hover:border-white">
        Продолжить покупки
      </a>
    </div>
  </div>
</section>
{% else %}
<div class="rounded-lg border border-white/10 bg-neutral-900 p-8 text-center">
  <p class="text-lg text-white/60 mb-4">Ваша корзина пуста</p>
  <a href="{% url 'index' %}" class="inline-block rounded-lg bg-blue-700 px-6 py-3 text-sm font-semibold text-white hover:bg-blue-800 transition">
    Перейти к каталогу
  </a>
</div>
{% endif %}
{% endblock %}
